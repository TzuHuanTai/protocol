syntax = "proto3";

package protocol;

import "camera_control.proto";

// CommandType defines the type of command being sent in the packet
enum CommandType {
  DISCONNECT       = 0;
  CONTROL_CAMERA   = 1;
  TAKE_SNAPSHOT    = 2;
  QUERY_FILE       = 3;
  TRANSFER_FILE    = 4;
  START_RECORDING  = 5;
  STOP_RECORDING   = 6;
  CUSTOM           = 100; // For IPC
}

// Response sent back to the client after START_RECORDING / STOP_RECORDING
message RecordingResponse {
  bool   is_recording = 1; // true = recording started, false = recording stopped
  string filepath     = 2; // current recording file path (empty when stopped)
}

message DisconnectRequest {
  enum DisconnectReason {
    UNKNOWN          = 0;
    CLIENT_INITIATED = 1;
  }
  DisconnectReason reason = 1;
}

// CameraControlRequest is used to send camera control commands, e.g., "exposure", "gain", etc.
message ControlCameraRequest {
  CameraControlId id    = 1;
  uint32          value = 2;
}

message TakeSnapshotRequest {
  uint32 quality = 1; // jpeg quality (0-100)
}

// QueryFileType defines the way of file query
enum QueryFileType  {
  LATEST_FILE = 0; // Request the latest file
  BEFORE_FILE = 1; // Request older files with the specified file name as parameter, e.g., "20260719_103000.mp4"
  BEFORE_TIME = 2; // Request files older than the specified time with parameter e.g., "20260719_103000"
}

// Video file request structures
message QueryFileRequest {
  QueryFileType type      = 1;
  string        parameter = 2;
}

message FileEntry {
  string filepath     = 1;
  uint32 duration_sec = 2;
  string thumbnail    = 3; // base64 jpeg image for previewing
}

// Video file metadata response structure
message QueryFileResponse {
  repeated FileEntry files = 1;
}

message TransferFileRequest {
  string filepath = 1; // The path of the file to transfer.
}

// Packet is the main message structure for communication
message Packet {
  CommandType type = 1;

  oneof payload {
    // Requests
    DisconnectRequest    disconnection_request  = 2;
    ControlCameraRequest control_camera_request = 3;
    TakeSnapshotRequest  take_snapshot_request  = 4;
    QueryFileRequest     query_file_request     = 5;
    TransferFileRequest  transfer_file_request  = 6;

    // Responses
    RecordingResponse recording_response = 10;

    // Generic streaming data for response file transfer or custom content
    StreamData.Header  stream_header  = 7;
    StreamData.Chunk   stream_chunk   = 8;
    StreamData.Trailer stream_trailer = 9;

    // For IPC, the payload is a raw byte array (e.g., JSON string) that can be parsed by the application
    bytes custom_command = 100;
  }
}

message StreamData {
  message Header  {
    string stream_id    = 1;
    uint64 total_length = 2;
  }

  message Chunk  {
    string stream_id = 1;
    uint64 offset    = 2;
    bytes  data      = 3;
  }

  message Trailer  {
    string stream_id = 1;
    string reason    = 2;
  }
}
